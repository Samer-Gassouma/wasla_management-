# Auto-Update System Documentation

## Overview

The Wasla Management desktop application includes an automatic update system that checks for updates from GitHub releases and allows users to download and install them seamlessly.

## How It Works

1. **Automatic Checks**: The app automatically checks for updates:
   - On startup (after 5 seconds delay)
   - Every 4 hours while the app is running

2. **Update Flow**:
   - When an update is available, users see a notification in the header
   - Users can manually check for updates using the "Vérifier mise à jour" button
   - Users can download and install updates when ready
   - Updates are automatically installed on app quit if downloaded

3. **Update Server**: Updates are served from GitHub Releases:
   - Repository: `N3on404/wasla_management-`
   - Provider: GitHub Releases
   - Auto-updater reads the `latest.yml` file generated by electron-builder

## Publishing Updates

### Prerequisites

1. **GitHub Token**: You need a GitHub Personal Access Token with `repo` scope
   - Create one at: https://github.com/settings/tokens
   - Save it as an environment variable: `GH_TOKEN`

2. **GitHub Repository**: Ensure the repository exists and you have push access

### Publishing a New Release

1. **Update Version**: Update the version in `package.json`:
   ```json
   "version": "1.1.8"
   ```

2. **Build and Publish**: Run the publish command:
   ```bash
   # Set your GitHub token
   export GH_TOKEN=your_github_token_here

   # Build and publish to GitHub Releases
   npm run build:publish
   ```

   This will:
   - Build the application
   - Create a GitHub release with the version number
   - Upload the built files (AppImage, Setup.exe, DMG, etc.)
   - Generate `latest.yml` for auto-updater

3. **Platform-Specific Builds**:
   ```bash
   # Build for Linux only
   npm run build:linux

   # Build for Windows only
   npm run build:win

   # Build for macOS only
   npm run build:mac
   ```

### Manual Release Process

If you prefer to create releases manually:

1. Build the app:
   ```bash
   npm run build
   ```

2. Create a GitHub Release:
   - Go to: https://github.com/N3on404/wasla_management-/releases/new
   - Tag: `v1.1.8` (must match package.json version)
   - Title: `Version 1.1.8`
   - Upload files from `release/1.1.8/`:
     - `Wasla Management-Linux-1.1.8.AppImage`
     - `latest-linux.yml`
     - `Wasla Management-Windows-1.1.8-Setup.exe` (if Windows)
     - `latest.yml` (if Windows)
     - etc.

## Update UI

The update status is displayed in the application:
- **For Supervisors**: In the page header next to the title
- **For Workers**: In the top bar next to the logout button

Update states:
- **Idle**: Shows "Vérifier mise à jour" button
- **Checking**: Shows spinner with "Vérification..."
- **Available**: Shows version number and "Télécharger" button
- **Downloading**: Shows progress bar with percentage
- **Downloaded**: Shows "Prêt à installer" and "Redémarrer" button
- **Error**: Shows error message and "Réessayer" button

## Testing Updates

### In Development Mode

Auto-updater is disabled in development mode. To test:

1. Build a production version:
   ```bash
   npm run build
   ```

2. Run the built app:
   ```bash
   ./release/1.1.8/linux-unpacked/management-desktop
   ```

3. Create a test release with a higher version number

### Testing Update Flow

1. Install version 1.1.7
2. Publish version 1.1.8 to GitHub
3. Open the app - it should detect the update after 5 seconds
4. Click "Télécharger" to download
5. Click "Redémarrer" to install

## Troubleshooting

### Updates Not Detected

1. **Check GitHub Token**: Ensure `GH_TOKEN` is set correctly
2. **Check Repository**: Verify repository name matches `electron-builder.json5`
3. **Check Release**: Ensure release exists on GitHub with correct tag format
4. **Check latest.yml**: Verify `latest.yml` file exists in the release assets

### Update Download Fails

1. **Check Internet Connection**: Ensure app can reach GitHub
2. **Check Permissions**: Ensure app has write permissions for update files
3. **Check Logs**: Check console logs for specific error messages

### Update Installation Fails

1. **Check Permissions**: Ensure app has permission to replace itself
2. **Close App Properly**: Ensure app is fully closed before update
3. **Manual Install**: Download and install manually if auto-update fails

## Configuration

### Update Check Interval

To change the update check interval, edit `electron/main.ts`:
```typescript
setInterval(() => {
  autoUpdater.checkForUpdates()
}, 4 * 60 * 60 * 1000) // Change 4 to desired hours
```

### Auto-Download Behavior

Current setting: `autoDownload = false` (user must click download)

To enable auto-download, edit `electron/main.ts`:
```typescript
autoUpdater.autoDownload = true
```

### Custom Update Server

To use a custom update server instead of GitHub, edit `electron-builder.json5`:
```json5
"publish": [
  {
    "provider": "generic",
    "url": "https://your-update-server.com/updates"
  }
]
```

## Security Notes

- Updates are verified using code signing (if configured)
- Only updates from the configured GitHub repository are accepted
- Update files are downloaded over HTTPS
- Users are prompted before installing updates

## Support

For issues or questions about the auto-update system, check:
- Electron Updater docs: https://www.electron.build/auto-update
- GitHub Releases: https://github.com/N3on404/wasla_management-/releases

